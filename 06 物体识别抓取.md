# 06 物体识别抓取

基于 YOLO 检测和手眼标定，实现完整的视觉抓取流程。

---

## 系统架构

```
YOLO 检测 → 像素坐标+深度 → 相机坐标 → 基座坐标 → MoveIt2 规划 → 抓取
```

**核心模块**：
- `coordinate_transformer.py` - 坐标变换
- `arm_controller.py` - 关节空间控制
- `moveit_arm_controller.py` - 笛卡尔空间控制（MoveIt2）
- `hand_controller.py` - 灵巧手控制
- `grasp_node.py` - 状态机主节点

---

## 快速启动

### 方式一：一键启动（推荐）

```bash
ros2 launch grasp_control bringup.launch.py
```

可选参数：
```bash
ros2 launch grasp_control bringup.launch.py \
    robot_ip:=192.168.1.211 \
    reverse_ip:=192.168.1.10
```

### 方式二：分步启动（调试用）

```bash
# 终端 1：相机
ros2 launch depthai_ros_driver camera.launch.py params_file:=$(ros2 pkg prefix yolo_center_detector)/share/yolo_center_detector/config/extended_disp.yaml

# 终端 2：机械臂
ros2 launch ur_robot_driver ur_control.launch.py ur_type:=ur5 robot_ip:=192.168.1.211 reverse_ip:=192.168.1.10 launch_rviz:=false

# 终端 3：手眼标定 TF
ros2 launch easy_handeye2 publish.launch.py name:=ur5_oak_eyehand

# 终端 4：灵巧手
ros2 run qbsofthand_control qbsofthand_control_node

# 终端 5：YOLO 检测
ros2 launch yolo_center_detector yolo_center.launch.py

# 终端 6：MoveIt2
ros2 launch ur_moveit_config ur_moveit.launch.py ur_type:=ur5

# 终端 7：抓取控制
ros2 launch grasp_control grasp_control.launch.py
```

### 触发抓取

```bash
ros2 service call /grasp_control_node/trigger std_srvs/srv/Trigger
```

---

## 状态机流程

```
IDLE → MOVE_HOME → DETECTING → CALCULATING → APPROACH → GRASPING → LIFTING → HANDOVER → RELEASING → IDLE
```

| 状态 | 动作 |
|------|------|
| IDLE | 等待触发 |
| MOVE_HOME | 移动到拍照位置 |
| DETECTING | 等待 YOLO 检测结果 |
| CALCULATING | 像素→相机→基座坐标转换 |
| APPROACH | MoveIt2 移动到物体上方 |
| GRASPING | 闭合灵巧手 |
| LIFTING | 抬起物体 |
| HANDOVER | 移动到递交位置 |
| RELEASING | 张开灵巧手 |

---

## 配置文件

配置文件位置：`src/grasp_control/config/grasp_config.yaml`

### 关键参数

```yaml
# 目标物体
detection:
  target_class: "orange"

# 抓取参数
grasp:
  approach_height: 0.03   # 物体上方 3cm
  lift_height: 0.10       # 抬起 10cm
  orientation:
    roll: 3.14159         # 水平抓取姿态
    pitch: 0.0
    yaw: 0.0

# 关键位置（关节角度，弧度）
positions:
  home: [-1.5708, -1.5708, 1.5708, -1.5708, -1.5708, 0.0]
  handover: [-0.7854, -1.0472, 1.5708, -2.0944, -1.5708, 0.0]

# MoveIt2
moveit:
  velocity_scaling: 0.3
  acceleration_scaling: 0.3
```

---

## 坐标变换原理

### 像素 → 相机坐标

```python
x_cam = (u - cx) * depth / fx
y_cam = (v - cy) * depth / fy
z_cam = depth
```

### 相机 → 基座坐标

通过 TF2 查询 `base_link ← oak_rgb_camera_optical_frame` 变换。

---

## 调试命令

```bash
# 查看检测结果
ros2 topic echo /centers

# 查看 TF 树
ros2 run tf2_tools view_frames

# 手动控制灵巧手
ros2 service call /qbsofthand_control_node/set_closure qbsofthand_control/srv/SetClosure "{closure: 0.5, duration_sec: 1.0}"
```

---

## 故障排查

| 问题 | 解决方案 |
|------|----------|
| TF 变换失败 | 确认手眼标定 publish 已启动 |
| MoveIt2 规划失败 | 检查目标位置是否在工作空间内 检查关节角限制 |
| 检测超时 | 确认 YOLO 节点运行且物体在视野内 |
| 深度为 0 | 物体太近/太远/反光，调整位置 |

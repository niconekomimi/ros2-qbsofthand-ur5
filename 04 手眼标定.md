# 手眼标定操作指南

本文档介绍使用 UR5 机械臂、OAK-D 相机和 ArUco 标记进行手眼标定的完整流程。

---

## 步骤 1：启动硬件节点

在两个独立终端中分别启动相机和机械臂驱动节点：

**终端 1 - 启动 OAK-D 相机节点：**
```bash
ros2 launch depthai_examples rgb_stereo_node.launch.py
```

**终端 2 - 启动 UR5 控制节点：**
```bash
ros2 launch ur_robot_driver ur_control.launch.py \
  ur_type:=ur5 \
  robot_ip:=192.168.1.211 \
  launch_rviz:=false \
  reverse_ip:=192.168.1.10
```

> 💡 **提示**：确保两个节点都成功启动且无报错后再进入下一步。

---

## 步骤 2：验证 UR5 的 TF 坐标系

检查机械臂的 TF 变换是否正常发布。

**运行验证命令：**
```bash
ros2 run tf2_ros tf2_echo base_link tool0
```

**预期输出示例：**
```
At time 1769256896.817293003
- Translation: [-0.125, 0.325, 0.608]
- Rotation: in Quaternion (xyzw) [0.696, -0.658, -0.210, -0.196]
- Rotation: in RPY (radian) [3.136, 0.582, -1.517]
- Rotation: in RPY (degree) [179.704, 33.356, -86.927]
- Matrix:
  0.045 -0.998 -0.035 -0.125
 -0.834 -0.056  0.549  0.325
 -0.550  0.004 -0.835  0.608
  0.000  0.000  0.000  1.000
```

> ℹ️ 该命令会持续以约 1Hz 的频率打印末端执行器（`tool0`）相对于基座（`base_link`）的变换矩阵。按 `Ctrl+C` 退出。

---

## 步骤 3：确认相机坐标系名称

生成 TF 树图并查找相机的光学坐标系名称。

**生成 TF 树：**
```bash
ros2 run tf2_tools view_frames
```

执行后会在当前目录生成 `frames.pdf` 文件，打开查看完整的 TF 树结构。

**查找光学坐标系：**

不同版本的 OAK-D 驱动可能使用不同的命名，常见的有：
- `camera_color_optical_frame`
- `oak_rgb_camera_optical_frame`
- `oak_camera_rgb_camera_optical_frame`

> 📌 **本系统使用的坐标系名称**：`oak_rgb_camera_optical_frame`

---

## 步骤 4：启动 ArUco 标记检测

### 4.1 准备 ArUco 标记

访问 [ArUco 生成器](https://chev.me/arucogen/) 并生成一个标记，打印后测量其尺寸。

> ⚠️ **重要**：记录标记的 **ID** 和 **边长**（黑色外框的实际尺寸，单位：米）

### 4.2 配置话题映射

根据你的系统，确认以下话题名称（可用 `ros2 topic list` 查看）：

| 参数 | 本机配置 | 说明 |
|------|----------|------|
| `image` 话题 | `/color/video/image` | RGB 图像流 |
| `camera_info` 话题 | `/color/video/camera_info` | 相机标定参数 |
| `camera_frame` | `oak_rgb_camera_optical_frame` | 相机光学坐标系 |

### 4.3 启动 ArUco 检测节点

**终端 3 - 运行 ArUco 检测：**
```bash
ros2 run aruco_ros single \
  --ros-args \
  -r /image:=/color/video/image \
  -r /camera_info:=/color/video/camera_info \
  -p marker_id:=123 \
  -p marker_size:=0.1 \
  -p camera_frame:=oak_rgb_camera_optical_frame \
  -p marker_frame:=aruco_marker_frame
```

**参数说明：**
- `marker_id`: 必须与打印的 ArUco 标记 ID 完全一致（例如 `123`）
- `marker_size`: 黑色外框的边长，单位**米**（5cm = `0.05`，10cm = `0.1`）

> ⚠️ **常见错误**：ID 或尺寸不匹配会导致检测失败或 TF 不发布。

---

## 步骤 5：验证 ArUco 检测结果

按以下顺序依次检查，确保每一步都成功后再进行下一步。

### 5.1 检查位姿输出

验证 ArUco 节点是否成功识别到标记：

```bash
ros2 topic echo /aruco_single/pose --once
```

**预期输出**：应看到包含 `position` 和 `orientation` 的 `geometry_msgs/PoseStamped` 消息。

### 5.2 检查变换输出

确认 ArUco 节点已计算出相机到标记的变换：

```bash
ros2 topic echo /aruco_single/transform --once
```

**预期输出示例：**
```yaml
header:
  frame_id: oak_rgb_camera_optical_frame
child_frame_id: aruco_marker_frame
transform:
  translation: {x: 0.015, y: 0.026, z: 0.505}
  rotation: {x: 0.018, y: 0.984, z: -0.175, w: -0.023}
```

### 5.3 检查 TF 树集成

验证 `aruco_marker_frame` 是否已加入 TF 树：

```bash
ros2 run tf2_ros tf2_echo oak_rgb_camera_optical_frame aruco_marker_frame
```

**预期输出**：持续打印相机到标记的变换矩阵。

---

## 步骤 6：执行手眼标定

### 6.1 启动标定界面

**终端 4 - 启动 easy_handeye2 标定程序：**
```bash
ros2 launch easy_handeye2 calibrate.launch.py \
  name:=ur5_oak_eyehand \
  calibration_type:=eye_in_hand \
  robot_base_frame:=base_link \
  robot_effector_frame:=tool0 \
  tracking_base_frame:=oak_rgb_camera_optical_frame \
  tracking_marker_frame:=aruco_marker_frame \
  camera_frame:=oak_rgb_camera_optical_frame \
  marker_frame:=aruco_marker_frame
```

**参数说明：**
- `name`: 标定配置名称（用于保存/加载标定结果）
- `calibration_type`: 标定类型（`eye_in_hand` = 相机固定在末端执行器上）
- `robot_base_frame` / `robot_effector_frame`: 机器人坐标系
- `tracking_base_frame` / `tracking_marker_frame`: 相机和标记坐标系

### 6.2 采集标定样本

1. **移动机械臂**到不同位姿，确保相机能清晰看到 ArUco 标记
2. 在标定界面**点击"Take Sample"**记录当前位姿
3. 重复上述步骤，**采集 15-25 个样本**

> 💡 **采样技巧**：
> - 尽量覆盖工作空间的不同区域和角度
> - 避免所有样本都在同一平面上
> - 确保每个样本中标记都被完整识别

4. 采集完成后，点击**"Compute"**计算标定结果
5. 查看标定误差，如果满意则点击**"Save"**保存

### 6.3 发布标定结果

标定完成后，**必须**启动发布节点将标定的 TF 持续发布到系统中，否则标定结果无法生效。

**终端 5 - 发布标定 TF：**
```bash
ros2 launch easy_handeye2 publish.launch.py name:=ur5_oak_eyehand
```

> ⚠️ **重要提示**：
> - 这一步是**必须**的，不可跳过
> - 该节点会根据保存的标定结果，持续发布 `tool0` → `oak_rgb_camera_optical_frame` 的变换
> - 如果不运行这一步，标定结果只保存在文件中，不会被 TF 系统使用
> - 建议将此命令添加到系统启动脚本中，确保每次重启都自动运行

### 6.4 验证标定结果

**生成新的 TF 树：**
```bash
ros2 run tf2_tools view_frames
```

打开 `frames.pdf`，确认存在完整的 TF 链：
```
base_link → ... → tool0 → oak_rgb_camera_optical_frame → aruco_marker_frame
```

**动态验证标定精度：**
```bash
ros2 run tf2_ros tf2_echo base_link aruco_marker_frame
```

移动机械臂到不同位姿，观察输出的变换矩阵：
- ✅ **期望**：标记在世界坐标系中的位置基本不变（允许小幅波动）
- ❌ **异常**：标记位置随机械臂移动而大幅漂移 → 标定失败，需重新标定

---

## 步骤 7：日常使用工作流

标定完成并验证后，以后每次要进行抓取或其他操作时，只需按以下步骤启动系统：

### 7.1 启动硬件节点（同步骤 1）

**终端 1 - 启动相机：**
```bash
ros2 launch depthai_examples rgb_stereo_node.launch.py
```

**终端 2 - 启动机械臂：**
```bash
ros2 launch ur_robot_driver ur_control.launch.py \
  ur_type:=ur5 \
  robot_ip:=192.168.1.211 \
  launch_rviz:=false \
  reverse_ip:=192.168.1.10
```

### 7.2 发布标定结果（**关键步骤**）

**终端 3 - 发布手眼标定 TF：**
```bash
ros2 launch easy_handeye2 publish.launch.py name:=ur5_oak_eyehand
```

> ⚠️ **这一步是连接机械臂和相机坐标系的关键**。运行此命令后，系统就能使用标定结果进行坐标变换，从而实现在相机坐标系中识别物体，然后指挥机械臂进行抓取。

### 7.3 启动应用程序

例如运行你的抓取程序、视觉识别程序等。

> 💡 **总结**：标定是一次性的工作，之后每次使用时只需重复"启动硬件 → 发布标定 TF → 运行应用"这三步即可。

---

## 附录：故障排查

### 问题 1：`tf2_echo` 提示 frame 不存在

**症状：**
```
Invalid frame ID "aruco_marker_frame" passed to canTransform - frame does not exist
```

**原因：**  
部分 `aruco_ros` 版本仅发布 `/aruco_single/transform` 话题，不会自动广播到 TF 树。

**解决方案：**

1. 确认 `/aruco_single/transform` 有数据（见[步骤 5.2](#52-检查变换输出)）
2. 如果有数据但 TF 树中查不到，启动 TF 转发脚本：

**终端 X - 启动 TF 转发：**
```bash
python3 tools/aruco_transform_to_tf.py
```

3. 保持该终端运行，在其他终端重新运行 `tf2_echo` 验证

---

### 问题 2：ArUco 标记无法识别

**可能原因：**
- ❌ `marker_id` 参数与实际打印的标记 ID 不符
- ❌ `marker_size` 参数与实际尺寸不符（记得单位是米）
- ❌ 光照不足或标记反光/模糊
- ❌ 话题映射错误（检查 `/color/video/image` 是否存在）

**调试步骤：**
1. 可视化检测结果：
   ```bash
   ros2 run image_tools showimage --ros-args -r image:=/aruco_single/result
   ```
2. 检查实际发布的图像话题：
   ```bash
   ros2 topic list | grep image
   ```
3. 确认标记参数：
   ```bash
   ros2 param get /aruco_single marker_id
   ros2 param get /aruco_single marker_size
   ```

---

### 问题 3：标定后 TF 链不完整

**症状：**  
`view_frames` 生成的 PDF 中，`base_link` 到 `oak_rgb_camera_optical_frame` 之间有断裂。

**原因：**  
未启动标定结果发布节点，或节点崩溃。

**解决方案：**
1. 确认发布节点正在运行：
   ```bash
   ros2 node list | grep easy_handeye
   ```
2. 重新启动发布节点：
   ```bash
   ros2 launch easy_handeye2 publish.launch.py name:=ur5_oak_eyehand
   ```

---

### 问题 4：标定结果漂移严重

**症状：**  
移动机械臂时，`base_link` → `aruco_marker_frame` 的变换随之变化（标记"跟着"机械臂移动）。

**原因：**
- 标定样本不足或分布不均
- 样本采集时标记识别不稳定
- 机械臂或相机安装松动

**解决方案：**
1. 重新标定，采集 **20+ 个高质量样本**
2. 确保样本覆盖多种位姿和角度
3. 检查相机与末端执行器的物理连接是否牢固

---

## 附录：可视化调试

实时查看 ArUco 检测结果（图像中会用框标出识别到的标记）：

```bash
ros2 run image_tools showimage --ros-args -r image:=/aruco_single/result
```

**用途：**
- 确认标记是否被正确识别
- 调整光照和标记位置
- 调试 ID/尺寸参数

按 `Ctrl+C` 关闭窗口。

---

## 附录：快速参考

### 常用命令

| 操作 | 命令 |
|------|------|
| 查看所有话题 | `ros2 topic list` |
| 查看所有节点 | `ros2 node list` |
| 生成 TF 树图 | `ros2 run tf2_tools view_frames` |
| 查看 TF 变换 | `ros2 run tf2_ros tf2_echo <source> <target>` |
| 单次读取话题 | `ros2 topic echo <topic> --once` |
| 查看节点参数 | `ros2 param list <node_name>` |
| 获取参数值 | `ros2 param get <node_name> <param>` |

### 关键坐标系

| 坐标系名称 | 所属系统 | 说明 |
|-----------|---------|------|
| `base_link` | UR5 | 机械臂基座 |
| `tool0` | UR5 | 末端执行器法兰 |
| `oak_rgb_camera_optical_frame` | OAK-D | 相机光学中心 |
| `aruco_marker_frame` | ArUco | 标记中心 |

### 标定流程概览

```
1. 启动硬件 → 2. 验证 TF → 3. 确认相机 frame
    ↓
4. 启动 ArUco → 5. 验证检测 → 6. 执行标定
    ↓
发布标定结果 → 验证精度 → 完成
```

---

## 相关资源

- [easy_handeye2 文档](https://github.com/marcoesposito1988/easy_handeye2)
- [ArUco 生成器](https://chev.me/arucogen/)
- [UR ROS2 驱动](https://github.com/UniversalRobots/Universal_Robots_ROS2_Driver)
- [depthai-ros 文档](https://github.com/luxonis/depthai-ros)




